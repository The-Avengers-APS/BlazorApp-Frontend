@using BlazorBootstrap
@using BlazorApp.Services.Notification
@inject INotificationService NotificationService
@implements IDisposable

<div class="notification-bell-container">
    <button class="notification-bell-button" @onclick="TogglePanel" @onclick:stopPropagation="true">
        <Icon Name="IconName.Bell" Size="IconSize.x4" />
        @if (_unreadCount > 0)
        {
            <span class="notification-badge">@(_unreadCount > 9 ? "9+" : _unreadCount.ToString())</span>
        }
    </button>

    @if (_showPanel)
    {
        <div class="notification-panel-overlay" @onclick="ClosePanel"></div>
        <NotificationPanel
            Notifications="_notifications"
            IsLoading="_isLoading"
            OnClose="ClosePanel"
            OnMarkAsRead="HandleMarkAsRead"
            OnMarkAllAsRead="HandleMarkAllAsRead" />
    }
</div>

@code {
    private int _unreadCount;
    private bool _showPanel;
    private bool _isLoading;
    private List<NotificationDto> _notifications = [];

    protected override async Task OnInitializedAsync()
    {
        NotificationService.OnNotificationsChanged += HandleNotificationsChanged;
        await NotificationService.StartPollingAsync();
        _unreadCount = NotificationService.UnreadCount;
    }

    private void HandleNotificationsChanged()
    {
        _unreadCount = NotificationService.UnreadCount;
        InvokeAsync(StateHasChanged);
    }

    private async Task TogglePanel()
    {
        _showPanel = !_showPanel;

        if (_showPanel)
        {
            _isLoading = true;
            StateHasChanged();

            _notifications = await NotificationService.GetNotificationsAsync(20);
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void ClosePanel()
    {
        _showPanel = false;
    }

    private async Task HandleMarkAsRead(string notificationId)
    {
        await NotificationService.MarkAsReadAsync(notificationId);
        _notifications = await NotificationService.GetNotificationsAsync(20);
        _unreadCount = NotificationService.UnreadCount;
    }

    private async Task HandleMarkAllAsRead()
    {
        await NotificationService.MarkAllAsReadAsync();
        _notifications = await NotificationService.GetNotificationsAsync(20);
        _unreadCount = 0;
    }

    public void Dispose()
    {
        NotificationService.OnNotificationsChanged -= HandleNotificationsChanged;
    }
}
