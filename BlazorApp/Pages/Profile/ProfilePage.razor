@page "/profile"
@attribute [Authorize]
@inject IAuthService AuthService
@inject IStatsService StatsService
@inject IUserService UserService
@inject NavigationManager Navigation

<div class="profile-container">
    <div class="container py-4">
        <!-- Profile Header -->
        <div class="profile-header mb-4">
            <h2 class="profile-title">Min Profil</h2>
            <p class="profile-subtitle">Velkommen tilbage, @DisplayName</p>
        </div>

        <!-- Profile Card -->
        <div class="profile-card mb-4">
            <div class="profile-card-content">
                <div class="profile-avatar">
                    <Icon Name="IconName.PersonCircle" Size="IconSize.x5" />
                </div>
                <h3 class="profile-name">@DisplayName</h3>
                <p class="profile-email">@UserEmail</p>
                <span class="membership-badge">@MembershipType</span>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid mb-4">
            <div class="stat-card">
                <div class="stat-icon stat-icon-warning">
                    <Icon Name="IconName.Fire" Size="IconSize.x3" />
                </div>
                <h3 class="stat-value">@totalWorkouts</h3>
                <p class="stat-label">Træninger</p>
            </div>
            <div class="stat-card">
                <div class="stat-icon stat-icon-success">
                    <Icon Name="IconName.CalendarCheck" Size="IconSize.x3" />
                </div>
                <h3 class="stat-value">@currentStreak</h3>
                <p class="stat-label">Dage Streak</p>
            </div>
            <div class="stat-card">
                <div class="stat-icon stat-icon-primary">
                    <Icon Name="IconName.ClockHistory" Size="IconSize.x3" />
                </div>
                <h3 class="stat-value">@totalHours</h3>
                <p class="stat-label">Timer Total</p>
            </div>
            <div class="stat-card">
                <div class="stat-icon stat-icon-danger">
                    <Icon Name="IconName.TrophyFill" Size="IconSize.x3" />
                </div>
                <h3 class="stat-value">@achievements</h3>
                <p class="stat-label">Præstationer</p>
            </div>
        </div>

        <!-- Body Metrics Card -->
        @if (_metrics != null && (_metrics.WeightKg.HasValue || _metrics.HeightCm.HasValue))
        {
            <div class="profile-card mb-4">
                <h4 class="settings-title">Kropsmål</h4>
                <div class="stats-grid">
                    @if (_metrics.WeightKg.HasValue)
                    {
                        <div class="stat-card">
                            <div class="stat-icon stat-icon-info">
                                <Icon Name="IconName.Speedometer" Size="IconSize.x3" />
                            </div>
                            <h3 class="stat-value">@_metrics.WeightKg.Value.ToString("F1")</h3>
                            <p class="stat-label">kg</p>
                        </div>
                    }
                    @if (_metrics.HeightCm.HasValue)
                    {
                        <div class="stat-card">
                            <div class="stat-icon stat-icon-secondary">
                                <Icon Name="IconName.ArrowsExpand" Size="IconSize.x3" />
                            </div>
                            <h3 class="stat-value">@_metrics.HeightCm.Value.ToString("F0")</h3>
                            <p class="stat-label">cm</p>
                        </div>
                    }
                    @if (_metrics.BmiValue.HasValue)
                    {
                        <div class="stat-card">
                            <div class="stat-icon stat-icon-primary">
                                <Icon Name="IconName.Activity" Size="IconSize.x3" />
                            </div>
                            <h3 class="stat-value">@_metrics.BmiValue.Value.ToString("F1")</h3>
                            <p class="stat-label">BMI (@(_metrics.BmiCategory ?? ""))</p>
                        </div>
                    }
                    @if (_metrics.AgeYears.HasValue)
                    {
                        <div class="stat-card">
                            <div class="stat-icon stat-icon-warning">
                                <Icon Name="IconName.Calendar3" Size="IconSize.x3" />
                            </div>
                            <h3 class="stat-value">@_metrics.AgeYears.Value</h3>
                            <p class="stat-label">år</p>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Settings Card -->
        <div class="settings-card">
            <h4 class="settings-title">Konto Indstillinger</h4>
            <div class="settings-list">
                <a href="#" class="settings-item">
                    <div class="settings-item-icon">
                        <Icon Name="IconName.PersonFill" />
                    </div>
                    <span class="settings-item-text">Rediger Profil</span>
                    <Icon Name="IconName.ChevronRight" />
                </a>
                <a href="#" class="settings-item">
                    <div class="settings-item-icon">
                        <Icon Name="IconName.Lock" />
                    </div>
                    <span class="settings-item-text">Skift Adgangskode</span>
                    <Icon Name="IconName.ChevronRight" />
                </a>
                <a href="#" class="settings-item">
                    <div class="settings-item-icon">
                        <Icon Name="IconName.Bell" />
                    </div>
                    <span class="settings-item-text">Notifikationer</span>
                    <Icon Name="IconName.ChevronRight" />
                </a>
                <a href="#" class="settings-item">
                    <div class="settings-item-icon">
                        <Icon Name="IconName.CreditCard" />
                    </div>
                    <span class="settings-item-text">Abonnement</span>
                    <Icon Name="IconName.ChevronRight" />
                </a>
            </div>
        </div>

        <!-- Logout Button -->
        <div class="logout-section">
            <button class="btn-logout" @onclick="Logout">
                <Icon Name="IconName.BoxArrowRight" />
                <span>Log ud</span>
            </button>
        </div>
    </div>
</div>

@code {
    private UserDto? _user;
    private string? _userRole;
    private bool _isLoading = true;
    private UserStatisticsDto? _statistics;
    private UserMetricsDto? _metrics;

    private int totalWorkouts => _statistics?.Training.TotalSessions ?? 0;
    private int currentStreak => _statistics?.TotalCheckIns ?? 0;
    private int totalHours => (_statistics?.Training.TotalMinutes ?? 0) / 60;
    private int achievements => _statistics?.AchievementIds.Count ?? 0;

    protected override async Task OnInitializedAsync()
    {
        _user = await AuthService.GetCurrentUserAsync();
        _userRole = await AuthService.GetCurrentRoleAsync();

        var statsTask = StatsService.GetMyStatisticsAsync();
        var metricsTask = UserService.GetMyMetricsAsync();
        await Task.WhenAll(statsTask, metricsTask);

        _statistics = statsTask.Result;
        _metrics = metricsTask.Result;
        _isLoading = false;
    }

    private string DisplayName => _user switch
    {
        { GivenName: not null, FamilyName: not null } => $"{_user.GivenName} {_user.FamilyName}",
        { GivenName: not null } => _user.GivenName,
        { Email: not null } => _user.Email,
        _ => "Bruger"
    };

    private string UserEmail => _user?.Email ?? "";

    private string MembershipType => _userRole switch
    {
        "Admin" => "Administrator",
        "Manager" => "Manager",
        "Trainer" => "Træner",
        "Staff" => "Personale",
        "Lead" => "Gratis bruger",
        "Partner" => "Partner",
        _ => "Medlem"
    };

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login", forceLoad: true);
    }
}