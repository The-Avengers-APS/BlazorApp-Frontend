@page "/bookingpage"
@inject IBookingService BookingService
@inject IGymService GymService
@inject IAuthService AuthService
@attribute [Authorize]

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>Hold</h1>
            <h5 class="text-muted mb-0">Book dine klasser</h5>
        </div>
        @if (IsAdmin)
        {
            <Button Color="ButtonColor.Primary" @onclick="() => ShowCreateModal = true">
                <Icon Name="IconName.PlusLg" /> Opret Hold
            </Button>
        }
    </div>

    <div class="gym-filter mb-4">
        <label class="form-label">Filtrer efter center</label>
        <select class="form-select" @bind="SelectedGymFilter">
            <option value="">Alle centre</option>
            @foreach (var gym in Gyms)
            {
                <option value="@gym.Id">@gym.Name</option>
            }
        </select>
    </div>

    @if (IsLoading)
    {
        <div class="text-center py-5">
            <Spinner Type="SpinnerType.Border" Color="SpinnerColor.Primary" />
            <p class="mt-2">Henter hold...</p>
        </div>
    }
    else if (ErrorMessage != null)
    {
        <Alert Color="AlertColor.Danger">
            <Icon Name="IconName.ExclamationTriangle" /> @ErrorMessage
            <Button Color="ButtonColor.Link" @onclick="LoadBookings">Prøv igen</Button>
        </Alert>
    }
    else if (!FilteredBookings.Any())
    {
        <Alert Color="AlertColor.Info">
            <Icon Name="IconName.InfoCircle" />
            @if (SelectedGymFilter.HasValue)
            {
                <span>Der er ingen hold på det valgte center.</span>
            }
            else
            {
                <span>Der er ingen hold tilgængelige i øjeblikket.</span>
            }
        </Alert>
    }
    else
    {
        <div class="booking-cards">
            @foreach (var booking in FilteredBookings)
            {
                <BookingCard
                    Booking="booking"
                    IsAdmin="IsAdmin"
                    OnBookingChanged="LoadBookings" />
            }
        </div>
    }
</div>

@if (ShowCreateModal)
{
    <Modal @ref="CreateModal" Title="Opret nyt hold" IsVerticallyCentered="true">
        <BodyTemplate>
            <div class="mb-3">
                <label class="form-label">Navn</label>
                <input type="text" class="form-control" @bind="NewBooking.Name" placeholder="f.eks. Morning Yoga" />
            </div>
            <div class="mb-3">
                <label class="form-label">Genre</label>
                <input type="text" class="form-control" @bind="NewBooking.Genre" placeholder="f.eks. Yoga, HIIT, Spinning" />
            </div>
            <div class="mb-3">
                <label class="form-label">Center</label>
                <select class="form-select" @bind="NewBooking.SelectedGymId">
                    <option value="">Vælg center...</option>
                    @foreach (var gym in Gyms)
                    {
                        <option value="@gym.Id">@gym.Name</option>
                    }
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Kapacitet</label>
                <input type="number" class="form-control" @bind="NewBooking.Capacity" min="1" />
            </div>
            <div class="row">
                <div class="col-6 mb-3">
                    <label class="form-label">Start tid</label>
                    <input type="datetime-local" class="form-control" @bind="NewBooking.TimeStart" />
                </div>
                <div class="col-6 mb-3">
                    <label class="form-label">Slut tid</label>
                    <input type="datetime-local" class="form-control" @bind="NewBooking.TimeEnd" />
                </div>
            </div>
            @if (!string.IsNullOrEmpty(CreateErrorMessage))
            {
                <Alert Color="AlertColor.Danger">@CreateErrorMessage</Alert>
            }
        </BodyTemplate>
        <FooterTemplate>
            <Button Color="ButtonColor.Secondary" @onclick="CloseCreateModal">Annuller</Button>
            <Button Color="ButtonColor.Primary" @onclick="CreateBooking" Disabled="IsCreating">
                @if (IsCreating)
                {
                    <Spinner Size="SpinnerSize.Small" />
                    <span> Opretter...</span>
                }
                else
                {
                    <span>Opret Hold</span>
                }
            </Button>
        </FooterTemplate>
    </Modal>
}

@code {
    private List<BookingDto> Bookings { get; set; } = new();
    private List<BlazorApp.Services.Gym.GymDto> Gyms { get; set; } = new();
    private bool IsLoading { get; set; } = true;
    private bool IsAdmin { get; set; }
    private string? ErrorMessage { get; set; }
    private Guid? SelectedGymFilter { get; set; }

    private List<BookingDto> FilteredBookings => SelectedGymFilter.HasValue
        ? Bookings.Where(b => b.GymId == SelectedGymFilter.Value).ToList()
        : Bookings;

    // Create modal state
    private bool ShowCreateModal { get; set; }
    private Modal? CreateModal { get; set; }
    private bool IsCreating { get; set; }
    private string? CreateErrorMessage { get; set; }
    private CreateBookingModel NewBooking { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        var role = await AuthService.GetCurrentRoleAsync();
        IsAdmin = role is "Admin" or "Manager";

        // Load gyms for the create form dropdown
        try
        {
            Gyms = await GymService.GetAllGymsAsync();
        }
        catch
        {
            // Gyms loading failure is not critical for viewing bookings
        }

        await LoadBookings();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (ShowCreateModal && CreateModal != null)
        {
            await CreateModal.ShowAsync();
        }
    }

    private async Task LoadBookings()
    {
        IsLoading = true;
        ErrorMessage = null;

        try
        {
            Bookings = await BookingService.GetAllBookingsAsync();

            // Filter out past bookings and sort by start time
            Bookings = Bookings
                .Where(b => b.TimeEnd > DateTime.UtcNow)
                .OrderBy(b => b.TimeStart)
                .ToList();
        }
        catch (Exception)
        {
            ErrorMessage = "Kunne ikke hente hold. Tjek din internetforbindelse.";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task CreateBooking()
    {
        CreateErrorMessage = null;

        if (string.IsNullOrWhiteSpace(NewBooking.Name))
        {
            CreateErrorMessage = "Navn er påkrævet.";
            return;
        }
        if (string.IsNullOrWhiteSpace(NewBooking.Genre))
        {
            CreateErrorMessage = "Genre er påkrævet.";
            return;
        }
        if (NewBooking.SelectedGymId == Guid.Empty)
        {
            CreateErrorMessage = "Center er påkrævet.";
            return;
        }
        if (NewBooking.Capacity < 1)
        {
            CreateErrorMessage = "Kapacitet skal være mindst 1.";
            return;
        }
        if (NewBooking.TimeStart == null || NewBooking.TimeEnd == null)
        {
            CreateErrorMessage = "Start og slut tid er påkrævet.";
            return;
        }
        if (NewBooking.TimeStart >= NewBooking.TimeEnd)
        {
            CreateErrorMessage = "Start tid skal være før slut tid.";
            return;
        }

        IsCreating = true;

        var selectedGym = Gyms.FirstOrDefault(g => g.Id == NewBooking.SelectedGymId);
        if (selectedGym == null)
        {
            CreateErrorMessage = "Ugyldigt center valgt.";
            IsCreating = false;
            return;
        }

        var createDto = new BookingCreateDto(
            NewBooking.Name,
            NewBooking.Genre,
            selectedGym.Id,
            selectedGym.Name,
            NewBooking.Capacity,
            NewBooking.TimeStart,
            NewBooking.TimeEnd
        );

        var result = await BookingService.CreateBookingAsync(createDto);

        if (result != null)
        {
            await CloseCreateModal();
            NewBooking = new CreateBookingModel();
            await LoadBookings();
        }
        else
        {
            CreateErrorMessage = "Kunne ikke oprette holdet. Prøv igen.";
        }

        IsCreating = false;
    }

    private async Task CloseCreateModal()
    {
        if (CreateModal != null)
        {
            await CreateModal.HideAsync();
        }
        ShowCreateModal = false;
        CreateErrorMessage = null;
    }

    private class CreateBookingModel
    {
        public string Name { get; set; } = "";
        public string Genre { get; set; } = "";
        public Guid SelectedGymId { get; set; } = Guid.Empty;
        public int Capacity { get; set; } = 20;
        public DateTime? TimeStart { get; set; } = DateTime.Now.AddHours(1);
        public DateTime? TimeEnd { get; set; } = DateTime.Now.AddHours(2);
    }
}
