@page "/"
@inject IBookingService BookingService
@inject IAuthService AuthService
@inject IStatsService StatsService
@attribute [Authorize]

<PageTitle>FitLife - Hjem</PageTitle>

<div class="homescreen-container">
    <Greetings Streak="@_userStreak" />
    <CheckIn Streak="@_userStreak" />
    <Recommended TodaysPlan="@_todaysPlan" NextSession="@_nextSession" />
    <LiveActivity Occupancy="@_gymOccupancy" />
    <QuickActions Actions="@_quickActions" />
</div>

@code {
    // User-specific data - will come from StatsService API
    private UserStreak _userStreak = new()
    {
        CurrentStreak = 0,
        StreakGoal = 7,
        LastCheckIn = DateTime.MinValue,
        CheckedInToday = false
    };

    // Will come from ExerciseService/TrainingService API
    private TrainingPlan _todaysPlan = new()
    {
        Name = "Ingen plan",
        ExerciseCount = 0,
        DurationMinutes = 0
    };

    // Will come from BookingService API
    private TeamSession _nextSession = new()
    {
        Name = "Ingen booking",
        Time = "-",
        AvailableSpots = 0
    };

    // Will come from real-time occupancy API
    private GymOccupancy _gymOccupancy = new()
    {
        CurrentOccupancy = 0,
        MaxCapacity = 150
    };

    // Navigation quick actions - these are static
    private List<QuickAction> _quickActions = new()
    {
        new QuickAction { IconName = "ClipboardCheck", Label = "Start Træning", Href = "/trainingpage" },
        new QuickAction { IconName = "CalendarCheck", Label = "Book Hold", Href = "/bookingpage" },
        new QuickAction { IconName = "GraphUpArrow", Label = "Min Progress", Href = "/progresspage" },
        new QuickAction { IconName = "ListCheck", Label = "Øvelser", Href = "/exercisespage" }
    };

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(
            LoadNextBookingAsync(),
            LoadUserStreakAsync()
        );
    }

    private async Task LoadUserStreakAsync()
    {
        try
        {
            var statistics = await StatsService.GetMyStatisticsAsync();
            if (statistics != null)
            {
                _userStreak = new UserStreak
                {
                    CurrentStreak = statistics.TotalCheckIns,
                    StreakGoal = 7,
                    LastCheckIn = statistics.Training.LastSessionDate ?? DateTime.MinValue,
                    CheckedInToday = statistics.Training.LastSessionDate?.Date == DateTime.Today
                };
            }
        }
        catch
        {
            // Keep default streak on error
        }
    }

    private async Task LoadNextBookingAsync()
    {
        try
        {
            var user = await AuthService.GetCurrentUserAsync();
            var userId = user?.Id.ToString();

            var bookings = await BookingService.GetAllBookingsAsync();

            // Find the user's next upcoming booking (one they're participating in)
            // Or if none, show the next available booking
            var now = DateTime.UtcNow;

            var userNextBooking = bookings
                .Where(b => b.TimeStart > now && userId != null && b.Participants.Contains(userId))
                .OrderBy(b => b.TimeStart)
                .FirstOrDefault();

            if (userNextBooking != null)
            {
                _nextSession = new TeamSession
                {
                    Name = userNextBooking.Name,
                    Time = FormatBookingTime(userNextBooking.TimeStart),
                    AvailableSpots = userNextBooking.AvailableSpots
                };
            }
            else
            {
                // Show next available booking if user hasn't booked anything
                var nextAvailable = bookings
                    .Where(b => b.TimeStart > now && !b.IsFull)
                    .OrderBy(b => b.TimeStart)
                    .FirstOrDefault();

                if (nextAvailable != null)
                {
                    _nextSession = new TeamSession
                    {
                        Name = nextAvailable.Name,
                        Time = FormatBookingTime(nextAvailable.TimeStart),
                        AvailableSpots = nextAvailable.AvailableSpots
                    };
                }
            }
        }
        catch
        {
            // Keep default "Ingen booking" on error
        }
    }

    private string FormatBookingTime(DateTime timeStart)
    {
        var today = DateTime.Today;
        var bookingDate = timeStart.Date;

        if (bookingDate == today)
            return $"I dag {timeStart:HH:mm}";
        if (bookingDate == today.AddDays(1))
            return $"I morgen {timeStart:HH:mm}";

        return $"{timeStart:dddd HH:mm}";
    }
}
