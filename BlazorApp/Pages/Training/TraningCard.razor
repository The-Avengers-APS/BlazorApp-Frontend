@inject IExerciseService ExerciseService
@inject IAuthService AuthService
@inject NavigationManager NavigationManager

<div class="training-card-wrapper" @onclick="NavigateToProgram">
    <Card Class="mb-3 training-card">
        <CardBody>
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="card-title mb-0">@Program.Title</h5>
                <Badge Color="@GetDifficultyColor()">@Program.Difficulty</Badge>
            </div>

            @if (!string.IsNullOrEmpty(Program.ShortDescription ?? Program.Description))
            {
                <p class="text-muted mb-3">@(Program.ShortDescription ?? Program.Description)</p>
            }

            <div class="d-flex gap-3 mb-3 text-muted">
                <small>
                    <Icon Name="IconName.Calendar3" Size="IconSize.x4" /> @Program.DurationWeeks uger
                </small>
                <small>
                    <Icon Name="IconName.ListCheck" Size="IconSize.x4" /> @Program.TotalWorkouts træninger
                </small>
                @if (!string.IsNullOrEmpty(Program.EstimatedTimePerWorkout))
                {
                    <small>
                        <Icon Name="IconName.Clock" Size="IconSize.x4" /> @Program.EstimatedTimePerWorkout
                    </small>
                }
            </div>

            <div @onclick:stopPropagation="true">
                @if (IsLoading)
                {
                    <Button Color="ButtonColor.Secondary" Class="w-100" Disabled="true">
                        <Spinner Size="SpinnerSize.Small" /> Arbejder...
                    </Button>
                }
                else if (IsEnrolled)
                {
                    <Button Color="ButtonColor.Success" Class="w-100" @onclick="NavigateToProgram">
                        <Icon Name="IconName.Eye" /> Se program
                    </Button>
                }
                else
                {
                    <Button Color="ButtonColor.Primary" Class="w-100" @onclick="EnrollInProgram">
                        Start Program
                    </Button>
                }
            </div>

            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <Alert Color="AlertColor.Danger" Class="mt-2 mb-0">@ErrorMessage</Alert>
            }
        </CardBody>
    </Card>
</div>

@code {
    [Parameter]
    public required TrainingProgramDto Program { get; set; }

    [Parameter]
    public EventCallback OnEnrollmentChanged { get; set; }

    [Parameter]
    public bool IsEnrolled { get; set; }

    private bool IsLoading { get; set; }
    private string? ErrorMessage { get; set; }

    private async Task EnrollInProgram()
    {
        IsLoading = true;
        ErrorMessage = null;

        try
        {
            var user = await AuthService.GetCurrentUserAsync();
            if (user == null)
            {
                ErrorMessage = "Du skal være logget ind for at tilmelde dig.";
                IsLoading = false;
                return;
            }

            var result = await ExerciseService.EnrollInProgramAsync(new EnrollProgramRequest(user.Id, Program.Id));

            if (result != null)
            {
                await OnEnrollmentChanged.InvokeAsync();
            }
            else
            {
                ErrorMessage = "Kunne ikke tilmelde dig programmet. Du er muligvis allerede tilmeldt.";
            }
        }
        catch
        {
            ErrorMessage = "Der opstod en fejl. Prøv igen.";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void NavigateToProgram()
    {
        NavigationManager.NavigateTo($"/training/{Program.Id}");
    }

    private BadgeColor GetDifficultyColor()
    {
        return Program.Difficulty switch
        {
            Difficulty.Begynder => BadgeColor.Success,
            Difficulty.Intermediær => BadgeColor.Warning,
            Difficulty.Avanceret => BadgeColor.Danger,
            _ => BadgeColor.Secondary
        };
    }
}
