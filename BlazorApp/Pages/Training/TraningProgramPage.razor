@page "/training/{Id:guid}"
@inject IExerciseService ExerciseService
@inject IAuthService AuthService
@inject NavigationManager NavigationManager
@attribute [Authorize]

<div class="program-detail-page">
    @if (IsLoading)
    {
        <div class="text-center py-5">
            <Spinner Type="SpinnerType.Border" Color="SpinnerColor.Primary" />
            <p class="mt-3 text-muted">Henter program...</p>
        </div>
    }
    else if (Program == null)
    {
        <Alert Color="AlertColor.Warning">
            <Icon Name="IconName.ExclamationTriangle" /> Programmet blev ikke fundet.
        </Alert>
        <Button Color="ButtonColor.Secondary" @onclick="GoBack">
            <Icon Name="IconName.ArrowLeft" /> Tilbage
        </Button>
    }
    else
    {
        <!-- Back button -->
        <div class="mb-3">
            <Button Color="ButtonColor.Light" Size="ButtonSize.Small" @onclick="GoBack">
                <Icon Name="IconName.ArrowLeft" /> Tilbage
            </Button>
        </div>

        <!-- Program Header -->
        <div class="program-header mb-4">
            <div class="d-flex justify-content-between align-items-start">
                <h2 class="mb-1">@Program.Title</h2>
                <Badge Color="@GetDifficultyColor()" Class="difficulty-badge">@Program.Difficulty</Badge>
            </div>
            @if (!string.IsNullOrEmpty(Program.ShortDescription ?? Program.Description))
            {
                <p class="text-muted mt-2">@(Program.ShortDescription ?? Program.Description)</p>
            }

            @* Completion count badge *@
            @if (UserProgram != null && UserProgram.CompletionCount > 0)
            {
                <Badge Color="BadgeColor.Info" Class="mt-2">
                    <Icon Name="IconName.Trophy" /> Du har klaret dette program @UserProgram.CompletionCount gang(e)
                </Badge>
            }
        </div>

        @* Program completion status *@
        @if (UserProgram?.Status == ProgramStatus.Completed)
        {
            <Alert Color="AlertColor.Success" Class="mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <Icon Name="IconName.Trophy" /> <strong>Tillykke!</strong> Du har gennemført programmet.
                        @if (UserProgram.CompletedAt.HasValue)
                        {
                            <span class="text-muted ms-2">(@UserProgram.CompletedAt.Value.ToString("d. MMM yyyy"))</span>
                        }
                    </div>
                    <Button Color="ButtonColor.Success" Size="ButtonSize.Small"
                            Loading="@IsRestartingProgram" Disabled="@IsRestartingProgram"
                            @onclick="RestartProgram">
                        <Icon Name="IconName.ArrowRepeat" /> Start programmet igen
                    </Button>
                </div>
            </Alert>
        }
        else if (UserProgram != null)
        {
            @* Show progress - based on exercises completed *@
            <div class="progress-card mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-bold">Din fremgang</span>
                    <span class="text-muted">@CompletedExercisesCount / @TotalExercisesCount øvelser</span>
                </div>
                <Progress Class="mb-0">
                    <ProgressBar Width="@ProgressPercentage" Color="ProgressColor.Success" />
                </Progress>
            </div>
        }

        <!-- Program Info -->
        <div class="info-card mb-4">
            <div class="info-grid">
                <div class="info-item">
                    <Icon Name="IconName.Calendar3" Size="IconSize.x5" />
                    <span class="info-value">@Program.DurationWeeks</span>
                    <span class="info-label">uger</span>
                </div>
                <div class="info-item">
                    <Icon Name="IconName.ListCheck" Size="IconSize.x5" />
                    <span class="info-value">@Program.TotalWorkouts</span>
                    <span class="info-label">træninger</span>
                </div>
                @if (!string.IsNullOrEmpty(Program.EstimatedTimePerWorkout))
                {
                    <div class="info-item">
                        <Icon Name="IconName.Clock" Size="IconSize.x5" />
                        <span class="info-value">@Program.EstimatedTimePerWorkout</span>
                        <span class="info-label">per træning</span>
                    </div>
                }
            </div>
        </div>

        <!-- Goals -->
        @if (Program.Goals?.Any() == true)
        {
            <div class="section-card mb-4">
                <h5 class="section-title">
                    <Icon Name="IconName.Bullseye" /> Mål
                </h5>
                <ul class="goals-list">
                    @foreach (var goal in Program.Goals)
                    {
                        <li>@goal</li>
                    }
                </ul>
            </div>
        }

        <!-- Guidelines -->
        @if (Program.GeneralGuidelines != null)
        {
            <div class="section-card mb-4">
                <h5 class="section-title">
                    <Icon Name="IconName.InfoCircle" /> Retningslinjer
                </h5>
                <div class="guidelines-content">
                    @if (!string.IsNullOrEmpty(Program.GeneralGuidelines.Warmup))
                    {
                        <div class="guideline-item">
                            <strong>Opvarmning:</strong> @Program.GeneralGuidelines.Warmup
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(Program.GeneralGuidelines.RestPeriods))
                    {
                        <div class="guideline-item">
                            <strong>Hvileperioder:</strong> @Program.GeneralGuidelines.RestPeriods
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(Program.GeneralGuidelines.TechniqueNotes))
                    {
                        <div class="guideline-item">
                            <strong>Teknik:</strong> @Program.GeneralGuidelines.TechniqueNotes
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(Program.GeneralGuidelines.Notes))
                    {
                        <div class="guideline-item">
                            <strong>Noter:</strong> @Program.GeneralGuidelines.Notes
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Progression Rules -->
        @if (Program.ProgressionRules != null)
        {
            <div class="section-card mb-4">
                <h5 class="section-title">
                    <Icon Name="IconName.GraphUpArrow" /> Progression
                </h5>
                <div class="guidelines-content">
                    @if (!string.IsNullOrEmpty(Program.ProgressionRules.Intensity))
                    {
                        <div class="guideline-item">
                            <strong>Intensitet:</strong> @Program.ProgressionRules.Intensity
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(Program.ProgressionRules.DoubleProgression))
                    {
                        <div class="guideline-item">
                            <strong>Dobbelt progression:</strong> @Program.ProgressionRules.DoubleProgression
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(Program.ProgressionRules.DeloadInfo))
                    {
                        <div class="guideline-item">
                            <strong>Deload:</strong> @Program.ProgressionRules.DeloadInfo
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Workouts -->
        <div class="section-card mb-4">
            <h5 class="section-title">
                <Icon Name="IconName.Activity" /> Træninger (@Program.Workouts.Count)
            </h5>

            @if (Program.Workouts.Any())
            {
                <div class="workouts-list">
                    @foreach (var programWorkout in Program.Workouts.OrderBy(workout => workout.OrderIndex))
                    {
                        var workout = Workouts.FirstOrDefault(workout => workout.Id == programWorkout.WorkoutId);
                        if (workout != null)
                        {
                            var userWorkout = GetUserWorkoutForWorkout(workout.Id);
                            <div class="workout-card">
                                <div class="workout-header" @onclick="() => ToggleWorkout(workout.Id)">
                                    <div class="workout-info">
                                        <h6 class="workout-title">@workout.Title</h6>
                                        @if (!string.IsNullOrEmpty(workout.Focus))
                                        {
                                            <Badge Color="BadgeColor.Info" Class="ms-2">@workout.Focus</Badge>
                                        }
                                        @if (userWorkout?.IsCompleted == true)
                                        {
                                            <Badge Color="BadgeColor.Success" Class="ms-2">Fuldført</Badge>
                                        }
                                        @if (!string.IsNullOrEmpty(programWorkout.DayOfWeek))
                                        {
                                            <span class="text-muted ms-2">(@programWorkout.DayOfWeek)</span>
                                        }
                                    </div>
                                    <div class="workout-toggle">
                                        <span class="text-muted">@GetWorkoutExerciseProgress(userWorkout, workout)</span>
                                        @if (userWorkout == null)
                                        {
                                            <span @onclick:stopPropagation="true">
                                                <Button Color="ButtonColor.Primary" Size="ButtonSize.Small" Class="workout-play-btn"
                                                        Loading="@IsStartingWorkout" Disabled="@IsStartingWorkout"
                                                        @onclick="() => StartWorkout(workout.Id)">
                                                    <Icon Name="IconName.PlayFill" />
                                                </Button>
                                            </span>
                                        }
                                        else if (!userWorkout.IsCompleted)
                                        {
                                            <span @onclick:stopPropagation="true">
                                                <Button Color="ButtonColor.Success" Size="ButtonSize.Small" Class="workout-play-btn"
                                                        Loading="@IsCompletingWorkout" Disabled="@IsCompletingWorkout"
                                                        @onclick="() => CompleteWorkout(userWorkout.Id)">
                                                    <Icon Name="IconName.CheckLg" />
                                                </Button>
                                            </span>
                                        }
                                        <Icon Name="@(ExpandedWorkouts.Contains(workout.Id) ? IconName.ChevronUp : IconName.ChevronDown)" />
                                    </div>
                                </div>

                                @if (ExpandedWorkouts.Contains(workout.Id))
                                {
                                    <div class="workout-exercises">
                                        @if (!string.IsNullOrEmpty(workout.Description))
                                        {
                                            <p class="text-muted small mb-3">@workout.Description</p>
                                        }

                                        @foreach (var workoutExercise in workout.Exercises.OrderBy(exercise => exercise.OrderIndex))
                                        {
                                            var exercise = Exercises.FirstOrDefault(exerciseItem => exerciseItem.Id == workoutExercise.ExerciseId);
                                            if (exercise != null)
                                            {
                                                <div class="exercise-item @(IsExerciseCompleted(userWorkout, workoutExercise.ExerciseId) ? "completed" : "")">
                                                    <div class="exercise-header">
                                                        @if (userWorkout != null && !userWorkout.IsCompleted)
                                                        {
                                                            <input type="checkbox"
                                                                   class="exercise-checkbox"
                                                                   checked="@IsExerciseCompleted(userWorkout, workoutExercise.ExerciseId)"
                                                                   @onchange="() => ToggleExerciseCompletion(userWorkout.Id, workoutExercise.ExerciseId)" />
                                                        }
                                                        else if (userWorkout?.IsCompleted == true)
                                                        {
                                                            <Icon Name="IconName.CheckCircleFill" Color="IconColor.Success" Class="me-2" />
                                                        }
                                                        <span class="exercise-order">@(workoutExercise.OrderIndex + 1).</span>
                                                        <span class="exercise-name">@exercise.Name</span>
                                                        @if (!string.IsNullOrEmpty(exercise.MuscleGroup))
                                                        {
                                                            <Badge Color="BadgeColor.Secondary" Class="ms-2">@exercise.MuscleGroup</Badge>
                                                        }
                                                    </div>
                                                    <div class="exercise-details">
                                                        <span class="detail-item">
                                                            <strong>@workoutExercise.DefaultSets</strong> sæt
                                                        </span>
                                                        @if (!string.IsNullOrEmpty(workoutExercise.DefaultReps ?? exercise.DefaultReps))
                                                        {
                                                            <span class="detail-item">
                                                                <strong>@(workoutExercise.DefaultReps ?? exercise.DefaultReps)</strong> reps
                                                            </span>
                                                        }
                                                        @if (!string.IsNullOrEmpty(workoutExercise.RirTarget ?? exercise.RirTarget))
                                                        {
                                                            <span class="detail-item rir">
                                                                RIR: <strong>@(workoutExercise.RirTarget ?? exercise.RirTarget)</strong>
                                                            </span>
                                                        }
                                                        @if (!string.IsNullOrEmpty(workoutExercise.Tempo ?? exercise.Tempo))
                                                        {
                                                            <span class="detail-item tempo">
                                                                Tempo: <strong>@(workoutExercise.Tempo ?? exercise.Tempo)</strong>
                                                            </span>
                                                        }
                                                        @if (!string.IsNullOrEmpty(workoutExercise.RestSeconds ?? exercise.RestSeconds))
                                                        {
                                                            <span class="detail-item">
                                                                Hvile: <strong>@(workoutExercise.RestSeconds ?? exercise.RestSeconds)</strong>
                                                            </span>
                                                        }
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(workoutExercise.Notes ?? exercise.Notes))
                                                    {
                                                        <div class="exercise-notes">
                                                            <Icon Name="IconName.ChatLeftText" /> @(workoutExercise.Notes ?? exercise.Notes)
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        }

                                        @* Workout completion status *@
                                        @if (userWorkout?.IsCompleted == true)
                                        {
                                            <div class="workout-completed-info mt-3 pt-3 border-top text-success">
                                                <Icon Name="IconName.CheckCircleFill" /> Fuldført @userWorkout.CompletedAt?.ToString("d. MMM yyyy")
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    }
                </div>
            }
            else
            {
                <Alert Color="AlertColor.Info" Class="mb-0">
                    Ingen træninger tilføjet endnu.
                </Alert>
            }
        </div>
    }
</div>

@* Incomplete exercises confirmation modal *@
<Modal @ref="IncompleteModal" Title="Afslut træning?">
    <BodyTemplate>
        <p>Du har ikke afsluttet alle øvelser.</p>
        <p><strong>@IncompleteExerciseCount øvelse(r)</strong> mangler stadig.</p>
        <p>Vil du afslutte træningen alligevel?</p>
    </BodyTemplate>
    <FooterTemplate>
        <Button Color="ButtonColor.Secondary" @onclick="CancelCompleteWorkout">
            Nej, fortsæt træning
        </Button>
        <Button Color="ButtonColor.Primary" @onclick="ConfirmCompleteWorkout">
            Ja, afslut træning
        </Button>
    </FooterTemplate>
</Modal>

@code {
    [Parameter]
    public Guid Id { get; set; }

    private TrainingProgramDto? Program { get; set; }
    private List<WorkoutDto> Workouts { get; set; } = new();
    private List<ExerciseDto> Exercises { get; set; } = new();
    private List<UserWorkoutDto> UserWorkouts { get; set; } = new();
    private UserProgramDto? UserProgram { get; set; }
    private HashSet<Guid> ExpandedWorkouts { get; set; } = new();
    private bool IsLoading { get; set; } = true;
    private bool IsStartingWorkout { get; set; }
    private bool IsCompletingWorkout { get; set; }
    private bool IsRestartingProgram { get; set; }
    private Guid? CurrentUserId { get; set; }

    // Modal for incomplete exercises confirmation
    private Modal IncompleteModal = default!;
    private Guid? PendingCompleteWorkoutId { get; set; }
    private int IncompleteExerciseCount { get; set; }

    // Progress calculated locally from ExerciseService data (single source of truth)
    private int TotalExercisesCount => Program?.Workouts.Sum(w =>
        Workouts.FirstOrDefault(wo => wo.Id == w.WorkoutId)?.Exercises.Count ?? 0) ?? 0;

    private int CompletedExercisesCount => UserWorkouts
        .Where(uw => uw.IsCompleted)
        .Sum(uw => uw.Exercises.Count(e => e.IsCompleted));

    private int ProgressPercentage => TotalExercisesCount > 0
        ? (CompletedExercisesCount * 100) / TotalExercisesCount
        : 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        IsLoading = true;
        try
        {
            var user = await AuthService.GetCurrentUserAsync();
            CurrentUserId = user?.Id;

            Program = await ExerciseService.GetTrainingProgramByIdAsync(Id);

            if (Program != null)
            {
                Workouts = await ExerciseService.GetAllWorkoutsAsync();
                Exercises = await ExerciseService.GetAllExercisesAsync();

                // Load user's program enrollment and workouts
                if (CurrentUserId.HasValue)
                {
                    var userPrograms = await ExerciseService.GetUserProgramsAsync(CurrentUserId.Value);
                    UserProgram = userPrograms.FirstOrDefault(up => up.ProgramId == Id);
                    UserWorkouts = await ExerciseService.GetUserWorkoutsForProgramAsync(Id, CurrentUserId.Value);
                    // Progress is calculated locally from UserWorkouts data
                }

                // Auto-expand first workout
                if (Program.Workouts.Any())
                {
                    var firstWorkout = Program.Workouts.OrderBy(workout => workout.OrderIndex).First();
                    ExpandedWorkouts.Add(firstWorkout.WorkoutId);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading program: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private UserWorkoutDto? GetUserWorkoutForWorkout(Guid workoutId)
    {
        return UserWorkouts.FirstOrDefault(userWorkout => userWorkout.WorkoutId == workoutId);
    }

    private string GetWorkoutExerciseProgress(UserWorkoutDto? userWorkout, WorkoutDto workout)
    {
        if (userWorkout == null)
        {
            return $"{workout.Exercises.Count} øvelser";
        }

        var completedCount = userWorkout.Exercises.Count(exercise => exercise.IsCompleted);
        var totalCount = workout.Exercises.Count;

        return $"{completedCount}/{totalCount} øvelser";
    }

    private async Task StartWorkout(Guid workoutId)
    {
        if (!CurrentUserId.HasValue) return;

        IsStartingWorkout = true;
        try
        {
            // Get exercises from workout template
            var workout = Workouts.FirstOrDefault(workout => workout.Id == workoutId);
            var exercises = workout?.Exercises.Select(exercise => new UserWorkoutExerciseInput(
                exercise.ExerciseId,
                exercise.OrderIndex,
                0, // Default weight
                ParseReps(exercise.DefaultReps)
            )).ToList();

            var request = new StartUserWorkoutRequest(
                CurrentUserId.Value,
                Id,
                workoutId,
                exercises
            );

            var result = await ExerciseService.StartUserWorkoutAsync(request);
            if (result != null)
            {
                UserWorkouts.Add(result);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error starting workout: {ex.Message}");
        }
        finally
        {
            IsStartingWorkout = false;
        }
    }

    private static int ParseReps(string? reps)
    {
        if (string.IsNullOrEmpty(reps)) return 10;
        if (reps.Contains('-'))
        {
            var parts = reps.Split('-');
            if (parts.Length == 2 && int.TryParse(parts[0], out var low) && int.TryParse(parts[1], out var high))
                return (low + high) / 2;
        }
        return int.TryParse(reps, out var single) ? single : 10;
    }

    private async Task CompleteWorkout(Guid userWorkoutId)
    {
        var userWorkout = UserWorkouts.FirstOrDefault(workout => workout.Id == userWorkoutId);
        if (userWorkout == null) return;

        // Check for incomplete exercises
        var incompleteCount = userWorkout.Exercises.Count(exercise => !exercise.IsCompleted);

        if (incompleteCount > 0)
        {
            // Show confirmation modal
            PendingCompleteWorkoutId = userWorkoutId;
            IncompleteExerciseCount = incompleteCount;
            await IncompleteModal.ShowAsync();
            return;
        }

        await FinishWorkout(userWorkoutId);
    }

    private async Task FinishWorkout(Guid userWorkoutId)
    {
        IsCompletingWorkout = true;
        try
        {
            var success = await ExerciseService.CompleteUserWorkoutAsync(userWorkoutId);
            if (success && CurrentUserId.HasValue)
            {
                UserWorkouts = await ExerciseService.GetUserWorkoutsForProgramAsync(Id, CurrentUserId.Value);
                // Also reload UserProgram to check if program is completed
                var userPrograms = await ExerciseService.GetUserProgramsAsync(CurrentUserId.Value);
                UserProgram = userPrograms.FirstOrDefault(up => up.ProgramId == Id);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error completing workout: {ex.Message}");
        }
        finally
        {
            IsCompletingWorkout = false;
        }
    }

    private async Task ConfirmCompleteWorkout()
    {
        if (PendingCompleteWorkoutId.HasValue)
        {
            await IncompleteModal.HideAsync();
            await FinishWorkout(PendingCompleteWorkoutId.Value);
            PendingCompleteWorkoutId = null;
        }
    }

    private async Task CancelCompleteWorkout()
    {
        await IncompleteModal.HideAsync();
        PendingCompleteWorkoutId = null;
    }

    private bool IsExerciseCompleted(UserWorkoutDto? userWorkout, Guid exerciseId)
    {
        if (userWorkout == null) return false;
        var exercise = userWorkout.Exercises.FirstOrDefault(exercise => exercise.ExerciseId == exerciseId);
        return exercise?.IsCompleted ?? false;
    }

    private async Task ToggleExerciseCompletion(Guid userWorkoutId, Guid exerciseId)
    {
        var userWorkout = UserWorkouts.FirstOrDefault(workout => workout.Id == userWorkoutId);
        if (userWorkout == null) return;

        var exercise = userWorkout.Exercises.FirstOrDefault(exercise => exercise.ExerciseId == exerciseId);
        if (exercise == null) return;

        var newState = !exercise.IsCompleted;
        var success = await ExerciseService.ToggleExerciseCompletionAsync(userWorkoutId, exerciseId, newState);

        if (success && CurrentUserId.HasValue)
        {
            // Reload UserWorkouts - progress is calculated automatically from this data
            UserWorkouts = await ExerciseService.GetUserWorkoutsForProgramAsync(Id, CurrentUserId.Value);
            StateHasChanged();
        }
    }

    private async Task RestartProgram()
    {
        if (UserProgram == null) return;

        IsRestartingProgram = true;
        try
        {
            var success = await ExerciseService.RestartProgramAsync(UserProgram.Id);
            if (success)
            {
                // Reload all data to reflect the restart
                await LoadData();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error restarting program: {ex.Message}");
        }
        finally
        {
            IsRestartingProgram = false;
        }
    }

    private void ToggleWorkout(Guid workoutId)
    {
        if (ExpandedWorkouts.Contains(workoutId))
        {
            ExpandedWorkouts.Remove(workoutId);
        }
        else
        {
            ExpandedWorkouts.Add(workoutId);
        }
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/trainingpage");
    }

    private BadgeColor GetDifficultyColor()
    {
        return Program?.Difficulty switch
        {
            Difficulty.Begynder => BadgeColor.Success,
            Difficulty.Intermediær => BadgeColor.Warning,
            Difficulty.Avanceret => BadgeColor.Danger,
            _ => BadgeColor.Secondary
        };
    }
}
